@model ActivitiesViewModel

@{
	ViewData["Title"] = "Activities";
}

@Html.AntiForgeryToken()

<section class="section section--head section--head-fixed">
	<div class="container">
		<div class="row">
			<div class="col-12 col-xl-6">
				<h1 class="section__title section__title--head">Activities</h1>
			</div>
		</div>
	</div>
</section>
<!-- end head -->
<!-- profile -->
<div class="catalog catalog--page">
	<div class="container">
		<div class="row">
			<div class="col-12">
				<div class="profile">

					<!-- tabs nav -->
					<ul class="nav nav-tabs profile__tabs" id="profile__tabs" role="tablist">
						<li class="nav-item">
							<a class="nav-link active" data-toggle="tab" href="#tab-1" role="tab" aria-controls="tab-1" aria-selected="true">Comments</a>
						</li>

						<li class="nav-item">
							<a class="nav-link" data-toggle="tab" href="#tab-2" role="tab" aria-controls="tab-2" aria-selected="false">Reviews</a>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</div>

	<div class="container">
		<!-- content tabs -->
		<div class="tab-content">
			<div class="tab-pane fade show active" id="tab-1" role="tabpanel">
				<div id="myCommentsContainer" data-page-size="@Model.CommentsPageSize">
					@await Html.PartialAsync("_MyCommentsTable",
						new MyCommentsTablePartialViewModel {
						    Comments = Model.MyComments,
						    TotalCount = Model.MyCommentsCount,
						    Page = Model.CommentsPage,
						    PageSize = Model.CommentsPageSize
						})
				</div>
			</div>

			<div class="tab-pane fade" id="tab-2" role="tabpanel">
				<div id="myReviewsContainer" data-page-size="@Model.ReviewsPageSize">
				    @await Html.PartialAsync("_MyReviewsTable",
				        new MyReviewsTablePartialViewModel {
				            Reviews = Model.MyReviews,
				            TotalCount = Model.MyReviewsCount,
				            Page = Model.ReviewsPage,
				            PageSize = Model.ReviewsPageSize
				        })
				</div>
			</div>
		</div>
		<!-- end content tabs -->
	</div>
</div>
<!-- end profile -->
<!-- modal view -->
<div id="modal-view" class="zoom-anim-dialog mfp-hide modal modal--view">
	<div class="modal__comments__autor">
		<img class="modal__comments__avatar" src="~/img/user.svg" alt="">
		<span class="modal__comments__name">John Doe</span>
		<span class="modal__comments__time">30.08.2018, 17:53</span>
	</div>
	<p class="modal__comments__text">There are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration in some form, by injected humour, or randomised words which don't look even slightly believable. If you are going to use a passage of Lorem Ipsum, you need to be sure there isn't anything embarrassing hidden in the middle of text.</p>
	<div class="modal__comments__actions">
		<div class="modal__comments__rate">
			<span><svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11 7.3273V14.6537" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" /><path d="M14.6667 10.9905H7.33333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" /><path fill-rule="evenodd" clip-rule="evenodd" d="M15.6857 1H6.31429C3.04762 1 1 3.31208 1 6.58516V15.4148C1 18.6879 3.0381 21 6.31429 21H15.6857C18.9619 21 21 18.6879 21 15.4148V6.58516C21 3.31208 18.9619 1 15.6857 1Z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" /></svg> 12</span>

			<span>7<svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.6667 10.9905H7.33333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" /><path fill-rule="evenodd" clip-rule="evenodd" d="M15.6857 1H6.31429C3.04762 1 1 3.31208 1 6.58516V15.4148C1 18.6879 3.0381 21 6.31429 21H15.6857C18.9619 21 21 18.6879 21 15.4148V6.58516C21 3.31208 18.9619 1 15.6857 1Z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" /></svg></span>
		</div>
	</div>
</div>
<!-- end modal view -->
<!-- modal delete -->
<div id="modal-delete" class="zoom-anim-dialog mfp-hide modal">
	<h6 class="modal__title">Comment delete</h6>

	<p class="modal__text">Are you sure to permanently delete this comment?</p>

	<div class="modal__btns">
		<button class="modal__btn modal__btn--apply" type="button">Delete</button>
		<button class="modal__btn modal__btn--dismiss" type="button">Dismiss</button>
	</div>
</div>
<!-- end modal delete -->
<!-- modal view -->
<div id="modal-view2" class="zoom-anim-dialog mfp-hide modal modal--view">
	<div class="modal__reviews__autor">
		<img class="modal__reviews__avatar" src="~/img/user.svg" alt="">
		<span class="modal__reviews__name">Best Marvel movie in my opinion</span>
		<span class="modal__reviews__time">24.08.2018, 17:53 by John Doe</span>

		<span class="modal__reviews__rating"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22,9.67A1,1,0,0,0,21.14,9l-5.69-.83L12.9,3a1,1,0,0,0-1.8,0L8.55,8.16,2.86,9a1,1,0,0,0-.81.68,1,1,0,0,0,.25,1l4.13,4-1,5.68A1,1,0,0,0,6.9,21.44L12,18.77l5.1,2.67a.93.93,0,0,0,.46.12,1,1,0,0,0,.59-.19,1,1,0,0,0,.4-1l-1-5.68,4.13-4A1,1,0,0,0,22,9.67Zm-6.15,4a1,1,0,0,0-.29.88l.72,4.2-3.76-2a1.06,1.06,0,0,0-.94,0l-3.76,2,.72-4.2a1,1,0,0,0-.29-.88l-3-3,4.21-.61a1,1,0,0,0,.76-.55L12,5.7l1.88,3.82a1,1,0,0,0,.76.55l4.21.61Z" /></svg> 8.4</span>
	</div>
	<p class="modal__reviews__text">There are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration in some form, by injected humour, or randomised words which don't look even slightly believable. If you are going to use a passage of Lorem Ipsum, you need to be sure there isn't anything embarrassing hidden in the middle of text.</p>
</div>
<!-- end modal view -->
<!-- modal delete -->
<div id="modal-delete2" class="zoom-anim-dialog mfp-hide modal">
	<h6 class="modal__title">Review delete</h6>

	<p class="modal__text">Are you sure to permanently delete this review?</p>

	<div class="modal__btns">
		<button class="modal__btn modal__btn--apply" type="button">Delete</button>
		<button class="modal__btn modal__btn--dismiss" type="button">Dismiss</button>
	</div>
</div>
<!-- end modal delete -->



@section Scripts {
<script>
  // Anti-forgery header (Layout-da token varsa)
  $.ajaxSetup({
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
    }
  });

  function scrollToBlockTop($wrap){
    var headerH = $('header.header').outerHeight() || 0;
    var top = Math.max(0, $wrap.offset().top - headerH*2);
    $('html, body').stop(true).animate({ scrollTop: top }, 350, 'swing');
  }

  // ----- COMMENTS PAGING -----
  $(document).off('click', '.js-mycomments-pager a')
             .on('click', '.js-mycomments-pager a', function(e){
    e.preventDefault();
    var url = $(this).attr('href');
    var $wrap = $('#myCommentsContainer');
    var prevH = $wrap.height();
    $wrap.css({ minHeight: prevH }).addClass('loading');
    scrollToBlockTop($wrap);
    $wrap.load(url, function(){
      $wrap.removeClass('loading').css({ minHeight: '' });
      // tab başlığında say göstərmək istəyərsənsə buradan götür: $('#js-mycomments-total').val()
    });
  });

  // ----- REVIEWS PAGING -----
  $(document).off('click', '.js-myreviews-pager a')
             .on('click', '.js-myreviews-pager a', function(e){
    e.preventDefault();
    var url = $(this).attr('href');
    var $wrap = $('#myReviewsContainer');
    var prevH = $wrap.height();
    $wrap.css({ minHeight: prevH }).addClass('loading');
    scrollToBlockTop($wrap);
    $wrap.load(url, function(){
      $wrap.removeClass('loading').css({ minHeight: '' });
    });
  });

  // ----- DELETE (common) -----
  const commentDeleteUrl = '@Url.Action("Delete","Comments")'; // WebApp CommentsController
  const reviewDeleteUrl  = '@Url.Action("Delete","Reviews")';  // WebApp ReviewsController
  let deleteTarget = { type:null, id:0 };

  // open comment delete modal
  $(document).on('click', '.js-mycomment-del', function(e){
    e.preventDefault();
    deleteTarget = { type:'comment', id: parseInt($(this).data('comment-id')||'0',10) };
    // 2 ayrı modal saxlayırsansa:
    $.magnificPopup.open({ items: { src: '#modal-delete' }, type: 'inline' });
  });

  // open review delete modal
  $(document).on('click', '.js-myreview-del', function(e){
    e.preventDefault();
    deleteTarget = { type:'review', id: parseInt($(this).data('review-id')||'0',10) };
    $.magnificPopup.open({ items: { src: '#modal-delete2' }, type: 'inline' });
  });

  // confirm buttons (2 modal üçün ayrı handlerlar)
  // COMMENT confirm
  $(document).on('click', '#modal-delete .modal__btn--apply', function(){
    if (!deleteTarget.id || deleteTarget.type!=='comment') return;
    const $btn = $(this).prop('disabled', true).text('Deleting...');
    const $wrap = $('#myCommentsContainer');
    const pageSize = parseInt($wrap.data('page-size')||'10',10);
    const currentPage = parseInt($wrap.find('.js-mycomments-pager li.active a').text()||'1',10) || 1;
    const totalBefore = parseInt($('#js-mycomments-total').val()||'0',10) || 0;

    $.post(commentDeleteUrl, { id: deleteTarget.id })
      .done(function(){
        const nextTotal = Math.max(0, totalBefore - 1);
        const nextPages = Math.max(1, Math.ceil(nextTotal / pageSize));
        const nextPage  = Math.min(currentPage, nextPages);
        const url = '@Url.Action("MyComments","Activities")' + `?page=${nextPage}&pageSize=${pageSize}`;
        $wrap.load(url, function(){
          $.magnificPopup.close();
          // yeni total hidden içindədir
        });
      })
      .fail(function(xhr){
        if (xhr.status===401){
          window.location='@Url.Action("Signin","Account")'+'?returnUrl='+encodeURIComponent(location.href);
        } else { alert('Failed to delete comment.'); }
      })
      .always(function(){ $btn.prop('disabled', false).text('Delete'); deleteTarget={type:null,id:0}; });
  });

  // REVIEW confirm
  $(document).on('click', '#modal-delete2 .modal__btn--apply', function(){
    if (!deleteTarget.id || deleteTarget.type!=='review') return;
    const $btn = $(this).prop('disabled', true).text('Deleting...');
    const $wrap = $('#myReviewsContainer');
    const pageSize = parseInt($wrap.data('page-size')||'5',10);
    const currentPage = parseInt($wrap.find('.js-myreviews-pager li.active a').text()||'1',10) || 1;
    const totalBefore = parseInt($('#js-myreviews-total').val()||'0',10) || 0;

    $.post(reviewDeleteUrl, { id: deleteTarget.id })
      .done(function(){
        const nextTotal = Math.max(0, totalBefore - 1);
        const nextPages = Math.max(1, Math.ceil(nextTotal / pageSize));
        const nextPage  = Math.min(currentPage, nextPages);
        const url = '@Url.Action("MyReviews","Activities")' + `?page=${nextPage}&pageSize=${pageSize}`;
        $wrap.load(url, function(){
          $.magnificPopup.close();
        });
      })
      .fail(function(xhr){
        if (xhr.status===401){
          window.location='@Url.Action("Signin","Account")'+'?returnUrl='+encodeURIComponent(location.href);
        } else { alert('Failed to delete review.'); }
      })
      .always(function(){ $btn.prop('disabled', false).text('Delete'); deleteTarget={type:null,id:0}; });
  });
</script>

<script>
// ISO tarixini "dd.MM.yyyy, HH:mm" formatına çevir
function fmt(iso){
  try {
    const d = new Date(iso);
    if (isNaN(d)) return '';
    const pad = n => String(n).padStart(2,'0');
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}, ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  } catch { return ''; }
}

// Span içindəki mətn node-ları saxlamadan yalnız rəqəmi yenilə (SVG toxunulmur)
function setCountKeepingSvg($span, value){
  // yalnız text node-ları sil
  $span.contents().filter(function(){ return this.nodeType === 3; }).remove();
  $span.append(' ' + (value ?? 0));
}

// —— COMMENTS: View —— //
$(document).off('click', '.js-comment-view')
           .on('click', '.js-comment-view', function(e){
  e.preventDefault();
  const $btn = $(this);
  const author   = $btn.data('author')   || '';
  const message  = $btn.data('message')  || '';
  const created  = $btn.data('date')     || '';
  const like     = parseInt($btn.data('like')||0,10);
  const dislike  = parseInt($btn.data('dislike')||0,10);

  const $modal = $('#modal-view');

  // Ad / tarix / mətn
  $modal.find('.modal__comments__name').text(author);
  $modal.find('.modal__comments__time').text(fmt(created));
  $modal.find('.modal__comments__text').text(message);

  // Like / Dislike sayları (SVG qalır)
  const $rateSpans = $modal.find('.modal__comments__rate span');
  setCountKeepingSvg($rateSpans.eq(0), like);
  setCountKeepingSvg($rateSpans.eq(1), dislike);

  // Modalı aç
  if ($.magnificPopup) $.magnificPopup.open({ items: { src: '#modal-view' }, type: 'inline' });
});

// —— REVIEWS: View —— //
$(document).off('click', '.js-review-view')
           .on('click', '.js-review-view', function(e){
  e.preventDefault();
  const $btn = $(this);
  const title   = $btn.data('title')   || '';
  const message = $btn.data('message') || '';
  const rating  = $btn.data('rating')  || 0;
  const created = $btn.data('date')    || '';
  const author  = $btn.data('author')  || '';

  const $modal = $('#modal-view2');

  // Başlıq (review title)
  $modal.find('.modal__reviews__name').text(title);

  // Tarix + müəllif
  const whenBy = fmt(created) + (author ? ` by ${author}` : '');
  $modal.find('.modal__reviews__time').text(whenBy);

  // Mesaj
  $modal.find('.modal__reviews__text').text(message);

  // Rating (SVG qalır, rəqəm yenilənir)
  const $rt = $modal.find('.modal__reviews__rating');
  setCountKeepingSvg($rt, rating);

  if ($.magnificPopup) $.magnificPopup.open({ items: { src: '#modal-view2' }, type: 'inline' });
});
</script>

<style>
  #myCommentsContainer.loading,
  #myReviewsContainer.loading { opacity:.6; pointer-events:none; transition:opacity .2s; }
</style>
}
