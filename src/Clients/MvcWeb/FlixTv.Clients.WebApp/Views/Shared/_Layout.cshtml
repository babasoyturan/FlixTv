<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- CSS -->
	<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <link rel="stylesheet" href="~/css/bootstrap-reboot.min.css">
    <link rel="stylesheet" href="~/css/bootstrap-grid.min.css">
    <link rel="stylesheet" href="~/css/owl.carousel.min.css">
    <link rel="stylesheet" href="~/css/slider-radio.css">
    <link rel="stylesheet" href="~/css/select2.min.css">
    <link rel="stylesheet" href="~/css/magnific-popup.css">
	<link rel="stylesheet" href="~/css/main.css">

    <!-- Favicons -->
    <link rel="icon" type="image/png" href="~/icon/favicon-32x32.png" sizes="32x32">
    <link rel="apple-touch-icon" href="~/icon/favicon-32x32.png">
    <title>FlixTV - @ViewData["Title"]</title>
    <script type="importmap"></script>
</head>
<body>
    <div id="app">
        <span id="top" style="position:absolute;top:0;left:0;width:0;height:0;overflow:hidden;"></span>

        <partial name="~/Views/Shared/HeaderPartial.cshtml" />

        @RenderBody()

        <partial name="~/Views/Shared/_FooterPartial.cshtml" />

    </div>

	<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
	<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
	<script src="~/js/jquery-3.5.1.min.js"></script>
	<script src="~/js/bootstrap.bundle.min.js"></script>
	<script src="~/js/owl.carousel.min.js"></script>
	<script src="~/js/slider-radio.js"></script>
	<script src="~/js/select2.min.js"></script>
	<script src="~/js/smooth-scrollbar.js"></script>
	<script src="~/js/jquery.magnific-popup.min.js"></script>
	<script src="~/js/admin.js"></script>
	<script src="~/js/main.js"></script>
    <script>
        (function () {
          // Auth flag (serverdən)
          window.__isAuth = @((User?.Identity?.IsAuthenticated ?? false).ToString().ToLower());

          // Ajax header-ları (antiforgery varsa əlavə olunur)
          $.ajaxSetup({
            headers: (function(){
              var h = { 'X-Requested-With': 'XMLHttpRequest' };
              var t = document.querySelector('input[name="__RequestVerificationToken"]');
              if (t && t.value) h['RequestVerificationToken'] = t.value;
              return h;
            })()
          });

          function allBtnsFor(mid){ return $('.js-fav-btn[data-movie-id="'+ mid +'"]'); }
          function setBtnState(mid, active){
            allBtnsFor(mid).each(function(){
              $(this).toggleClass('active', !!active)
                     .attr('aria-pressed', !!active);
            });
          }

          // Login yoxdursa – bütün favourite düymələrini gizlət
          if (!window.__isAuth) {
            $('.js-fav-btn').remove(); // ya da: .hide()
            return;
          }

          // Favourites grid-i varsa, hazır function
          function reloadFavouritesGridIfExists(){
            var $wrap = $('#favContainer');
            if (!$wrap.length) return;

            var $grid = $('#moviesGridWrap');
            var $active = $grid.find('.js-movies-pager li.active a');
            var page = parseInt(($active.text() || '1'), 10) || 1;
            var ps = parseInt($('#js-movies-page-size').val() || $grid.data('page-size') || '12', 10);

            var url = '@Url.Action("FavouritesGrid", "Movies")' + '?page=' + page + '&pageSize=' + ps;

            var prevH = $grid.height();
            $grid.css({ minHeight: prevH }).addClass('loading');

            $.get(url)
              .done(function(html){
                $grid.html(html);
                var ps2 = $('#js-movies-page-size').val();
                if (ps2) $grid.data('page-size', parseInt(ps2,10));
              })
              .always(function(){
                $grid.removeClass('loading').css({ minHeight: '' });
              });
          }

          // Klik – Toggle
          $(document).on('click', '.js-fav-btn', function(e){
            e.preventDefault();
            var $btn = $(this);
            if ($btn.data('busy')) return;
            $btn.data('busy', true);

            var movieId = parseInt($btn.attr('data-movie-id') || '0', 10);
            var willBeActive = !$btn.hasClass('active'); // OPTIMISTIC next state

            // Optimistic UI – bütün eyni movie-id-lərdə sinxron
            setBtnState(movieId, willBeActive);

            $.post('@Url.Action("ToggleFavourite", "Movies")', { movieId: movieId })
             .done(function(){
               // server OK – optimistic qalır
               if (!willBeActive) {
                 // Favourites səhifəsində id söndürülübsə grid-i yenilə
                 reloadFavouritesGridIfExists();
               }
             })
             .fail(function(xhr){
               // rollback
               setBtnState(movieId, !willBeActive);
               if (xhr.status === 401) {
                 window.location = '@Url.Action("Signin", "Account")' + '?returnUrl=' + encodeURIComponent(location.href);
               } else {
                 alert('Could not update favourites.');
               }
             })
             .always(function(){ $btn.data('busy', false); });
          });
        })();
    </script>
    <script>
        (function () {
          // Sabit header hündürlüyünü nəzərə al
          function headerOffset() {
            const h = document.querySelector('header.header');
            return (h?.offsetHeight || 0) + 16; // bir az buffer
          }
          function smoothToTop() {
            const el = document.getElementById('top');
            const y = el
              ? Math.max(0, el.getBoundingClientRect().top + window.pageYOffset - headerOffset())
              : 0;
            window.scrollTo({ top: y, behavior: 'smooth' });
          }

          // Event delegation – footer-in içindəki linkə fərq etməz, həmişə tutacaq
          document.addEventListener('click', function (e) {
            const a = e.target.closest('a.js-backtotop, a[href="#top"], button.js-backtotop');
            if (!a) return;
            e.preventDefault();
            smoothToTop();
          });
        })();
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
